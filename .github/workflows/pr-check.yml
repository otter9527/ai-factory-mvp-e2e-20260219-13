name: PR Check

on:
  push:
    branches:
      - "worker/**"

permissions:
  contents: read
  pull-requests: read
  issues: read

jobs:
  policy-check:
    name: policy-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Build policy context from branch
        run: |
          REF="$GITHUB_REF_NAME"
          NUM=$(echo "$REF" | grep -Eo '[0-9]+' | tail -1)
          if [[ -z "$NUM" ]]; then
            echo "Cannot parse task number from branch: $REF" >&2
            exit 1
          fi
          MARKER=$(printf 'task_%03d' "$NUM")
          COMMIT_MSG=$(git log -1 --pretty=%s)
          if [[ "$COMMIT_MSG" != *"TASK-"* ]]; then
            echo "Commit message must include TASK-* token" >&2
            exit 1
          fi
          python - <<PY
import json
from pathlib import Path
payload = {"ok": True, "ref": "${REF}", "marker": "${MARKER}", "commit": "${COMMIT_MSG}"}
Path('/tmp/policy.json').write_text(json.dumps(payload), encoding='utf-8')
PY
          cat /tmp/policy.json

  lint-format:
    name: lint-format
    runs-on: ubuntu-latest
    needs: [policy-check]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Syntax compile
        run: python -m compileall src scripts

  unit-tests:
    name: unit-tests
    runs-on: ubuntu-latest
    needs: [policy-check]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: python -m pip install -r requirements.txt
      - name: Run unit tests
        run: python -m pytest tests/unit -v

  acceptance-tests:
    name: acceptance-tests
    runs-on: ubuntu-latest
    needs: [policy-check]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: python -m pip install -r requirements.txt
      - name: Resolve task marker
        run: |
          REF="$GITHUB_REF_NAME"
          NUM=$(echo "$REF" | grep -Eo '[0-9]+' | tail -1)
          if [[ -z "$NUM" ]]; then
            echo "Cannot parse task number from branch: $REF" >&2
            exit 1
          fi
          MARKER=$(printf 'task_%03d' "$NUM")
          echo "marker=${MARKER}" >> "$GITHUB_ENV"
      - name: Run acceptance tests
        run: python -m pytest tests/acceptance -m "$marker" -v
